<?xml version="1.0"?>
<robot name="mark3" xmlns:xacro="http://ros.org/wiki/xacro">

  <!-- ================== BASE FOOTPRINT ================== -->
  <link name="base_footprint"/>
  <joint name="base_joint" type="fixed">
    <parent link="base_footprint"/>
    <child link="base_link"/>
    <origin xyz="0 0 0.05" rpy="0 0 0"/>
  </joint>

  <!-- ================== BASE LINK ================== -->
  <link name="base_link">
    <visual>
      <geometry>
        <box size="0.3 0.2 0.1"/>
      </geometry>
      <material name="blue">
        <color rgba="0 0 1 1"/>
      </material>
    </visual>
    <collision>
      <geometry>
        <box size="0.3 0.2 0.1"/>
      </geometry>
    </collision>
    <inertial>
      <mass value="2.0"/>
      <inertia ixx="0.1" ixy="0.0" ixz="0.0"
               iyy="0.1" iyz="0.0" izz="0.1"/>
    </inertial>
  </link>

  <!-- ================== WHEELS ================== -->
  <!-- Front Left -->
  <link name="wheel_left_front"/>
  <joint name="wheel_left_front_joint" type="continuous">
    <origin xyz="0.12 0.1 0" rpy="0 0 0"/>
    <parent link="base_link"/>
    <child link="wheel_left_front"/>
    <axis xyz="0 1 0"/>
  </joint>

  <!-- Front Right -->
  <link name="wheel_right_front"/>
  <joint name="wheel_right_front_joint" type="continuous">
    <origin xyz="0.12 -0.1 0" rpy="0 0 0"/>
    <parent link="base_link"/>
    <child link="wheel_right_front"/>
    <axis xyz="0 1 0"/>
  </joint>

  <!-- Rear Left -->
  <link name="wheel_left_back"/>
  <joint name="wheel_left_back_joint" type="continuous">
    <origin xyz="-0.12 0.1 0" rpy="0 0 0"/>
    <parent link="base_link"/>
    <child link="wheel_left_back"/>
    <axis xyz="0 1 0"/>
  </joint>

  <!-- Rear Right -->
  <link name="wheel_right_back"/>
  <joint name="wheel_right_back_joint" type="continuous">
    <origin xyz="-0.12 -0.1 0" rpy="0 0 0"/>
    <parent link="base_link"/>
    <child link="wheel_right_back"/>
    <axis xyz="0 1 0"/>
  </joint>

  <!-- ================== LIDAR ================== -->
  <link name="laser">
    <visual>
      <geometry>
        <cylinder radius="0.04" length="0.05"/>
      </geometry>
      <material name="black">
        <color rgba="0 0 0 1"/>
      </material>
    </visual>
  </link>

  <joint name="lidar_joint" type="fixed">
    <origin xyz="0 0 0.15" rpy="0 0 0"/>
    <parent link="base_link"/>
    <child link="laser"/>
  </joint>

  <gazebo reference="laser">
    <sensor name="lidar" type="gpu_lidar">
      <update_rate>20</update_rate>
      <lidar>
        <horizontal>
          <samples>360</samples>
          <resolution>1</resolution>
          <min_angle>-3.14</min_angle>
          <max_angle>3.14</max_angle>
        </horizontal>
        <vertical>
          <samples>1</samples>
          <resolution>1</resolution>
          <min_angle>0</min_angle>
          <max_angle>0</max_angle>
        </vertical>
        <range>
          <min>0.12</min>
          <max>10.0</max>
          <resolution>0.01</resolution>
        </range>
      </lidar>
    </sensor>
  </gazebo>

  <!-- ================== IMU ================== -->
  <link name="imu_link">
    <visual>
      <geometry>
        <box size="0.05 0.05 0.03"/>
      </geometry>
      <material name="red">
        <color rgba="1 0 0 1"/>
      </material>
    </visual>
  </link>

  <joint name="imu_joint" type="fixed">
    <origin xyz="0 0 0.08" rpy="0 0 0"/>
    <parent link="base_link"/>
    <child link="imu_link"/>
  </joint>

  <gazebo reference="imu_link">
    <sensor name="imu" type="imu">
      <always_on>true</always_on>
      <update_rate>50</update_rate>
      <visualize>false</visualize>
    </sensor>
  </gazebo>

  <!-- ================== DIFF DRIVE CONTROL ================== -->
  <gazebo>
    <plugin name="diff_drive" filename="gz-sim-diff-drive-system">
      <left_joint>wheel_left_front_joint</left_joint>
      <left_joint>wheel_left_back_joint</left_joint>
      <right_joint>wheel_right_front_joint</right_joint>
      <right_joint>wheel_right_back_joint</right_joint>
      <wheel_separation>0.20</wheel_separation>
      <wheel_radius>0.03</wheel_radius>
      <topic>cmd_vel</topic>
      <odom_topic>odom</odom_topic>
      <frame_id>odom</frame_id>
      <child_frame_id>base_link</child_frame_id>
      <publish_rate>50</publish_rate>
    </plugin>
  </gazebo>

</robot>

